name: Validate PR

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout (with full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate changed files
        id: validation
        env:
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          BASE_REF: ${{ github.base_ref }}
        run: |
          python3 - <<'PYEOF'
          import os
          import subprocess
          import sys

          author = os.environ["PR_AUTHOR"].lower()
          base_ref = os.environ["BASE_REF"]

          result = subprocess.run(
              ["git", "diff", "--name-only", f"origin/{base_ref}...HEAD"],
              capture_output=True, text=True
          )
          changed = [f.strip() for f in result.stdout.splitlines() if f.strip()]

          PROTECTED_FILES  = {"all_strategies.py", "my_strategies.py", "readme.md", "simulator_combined_strategies.py", "test_simulator.py"}
          PROTECTED_DIRS   = {"base/", ".github/", "scripts/"}
          STRATEGIES_DIR   = "strategies/"

          errors = []
          is_simulator_change = False

          for f in changed:
              # 1. Detect simulator/protected changes â€” flag but don't error
              if f in PROTECTED_FILES or any(f.startswith(d) for d in PROTECTED_DIRS):
                  is_simulator_change = True
                  print(f"  âš ï¸  '{f}' is a protected file â€” needs owner review.")
                  continue

              # 2. Must be inside the strategies/ folder
              if not f.startswith(STRATEGIES_DIR):
                  errors.append(f"âŒ '{f}' must be inside the '{STRATEGIES_DIR}' folder.")
                  continue

              # 3. Must end in _strategies.py
              if not f.endswith("_strategies.py"):
                  errors.append(f"âŒ '{f}' must end in '_strategies.py'.")
                  continue

              # 3. Check ownership via git history
              log = subprocess.run(
                  ["git", "log", "--follow", "--diff-filter=A",
                   "--format=%ae %an", f"origin/{base_ref}", "--", f],
                  capture_output=True, text=True
              )
              first_commit_info = log.stdout.strip()

              if first_commit_info:
                  if author not in first_commit_info.lower():
                      errors.append(
                          f"âŒ '{f}' was created by someone else. "
                          f"You can only edit files you created yourself."
                      )
                  else:
                      print(f"  âœ… '{f}' ownership confirmed for '{author}'.")
              else:
                  print(f"  âœ… '{f}' is a new file, no ownership check needed.")

          env_file = os.environ.get("GITHUB_OUTPUT", "/dev/null")
          with open(env_file, "a") as out:
              out.write(f"is_simulator_change={'true' if is_simulator_change else 'false'}\n")
              out.write(f"has_errors={'true' if errors else 'false'}\n")

          if errors:
              print("\nValidation failed:")
              print("\n".join(errors))
              sys.exit(1)
          elif is_simulator_change:
              print(f"\nâš ï¸  PR contains protected file changes â€” flagging for manual review.")
          else:
              print(f"\nâœ… All {len(changed)} file(s) validated for user '{author}'.")
          PYEOF

      - name: Label as simulator change (needs review)
        if: steps.validation.outputs.is_simulator_change == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr edit ${{ github.event.pull_request.number }} \
            --add-label "simulator-change" \
            --repo ${{ github.repository }}
          echo "ðŸ·ï¸  Label 'simulator-change' added. Waiting for owner review."

      - name: Auto-merge PR (only if no protected files touched)
        if: >
          success() &&
          steps.validation.outputs.is_simulator_change == 'false' &&
          steps.validation.outputs.has_errors == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge ${{ github.event.pull_request.number }} \
            --merge \
            --auto \
            --repo ${{ github.repository }}